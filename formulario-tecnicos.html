<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Técnico Profesional (Storage)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- EMAILJS – CORREO AUTOMÁTICO CON LOGO -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() { emailjs.init("iH-ohiBk9St_NK5-U"); })();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; padding: 20px 10px; display: flex; justify-content: center; min-height: 100vh; }
        .form-container { width: 100%; max-width: 450px; background-color: #1a1a1a; padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0, 123, 255, 0.2); }
        h1 { color: #007bff; font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; text-align: center; }
        .subtitle { color: #ccc; margin-bottom: 25px; text-align: center; }
        .input-field { width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 15px; background-color: #2a2a2a; border: 1px solid #374151; border-radius: 8px; color: #fff; box-sizing: border-box; transition: border-color 0.3s; }
        .input-field:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3); }
        input[type="file"].input-field { padding-top: 9px; padding-bottom: 9px; }
        .submit-button { width: 100%; padding: 15px; background: linear-gradient(145deg, #007bff, #0056b3); color: #fff; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(0, 123, 255, 0.6); margin-top: 20px; }
        .submit-button:hover { background: linear-gradient(145deg, #0056b3, #007bff); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 123, 255, 0.7); }
        .submit-button:disabled { background: #505050; cursor: not-allowed; box-shadow: none; }
        #message-box { padding: 12px; border-radius: 8px; margin-top: 20px; text-align: center; font-weight: bold; display: none; }
        .success { background-color: #16a34a; color: #fff; }
        .error { background-color: #dc2626; color: #fff; }
        .loading { background-color: #f59e0b; color: #fff; }
    </style>
</head>
<body>
<div class="form-container">
    <h1>Registro TechUIT Profesional</h1>
    <p class="subtitle">Completa tus datos y adjunta tu documentación. Las fotos se guardarán en Supabase Storage.</p>
    
    <form id="techForm">
        <label class="block text-sm font-medium mb-1">Nombre Completo *</label>
        <input type="text" name="nombre" class="input-field" required placeholder="Tu nombre y apellido">

        <label class="block text-sm font-medium mb-1">Cédula o Identificación *</label>
        <input type="text" name="cedula" class="input-field" required placeholder="Número de identificación oficial">

        <label class="block text-sm font-medium mb-1">Correo Electrónico *</label>
        <input type="email" name="email" class="input-field" required placeholder="ejemplo@servicio.com">

        <label class="block text-sm font-medium mb-1">Teléfono (WhatsApp) *</label>
        <input type="tel" name="telefono" class="input-field" required placeholder="+504...">

        <label class="block text-sm font-medium mb-1">Correo PayPal (obligatorio) *</label>
        <input type="email" name="paypal" class="input-field" required placeholder="tucorreo@paypal.com">
        <p class="text-xs text-gray-400 mb-6">
          Aquí recibís tus pagos cada viernes. 
          <a href="https://www.paypal.com/hn/webapps/mpp/account-selection" target="_blank" class="underline text-cyan-400 hover:text-cyan-300">¿No tenés cuenta? Creala aquí</a>
        </p>

        <label class="block text-sm font-medium mb-1">Especialidad Principal *</label>
        <select name="especialidad" class="input-field" required>
            <option value="" disabled selected>Selecciona tu área</option>
            <option value="Hardware - PC/Laptop">Hardware (Reparación, Ensamblaje)</option>
            <option value="Software/Sistemas">Software, Sistemas Operativos</option>
            <option value="Redes y Conectividad">Redes y Configuración</option>
            <option value="Desarrollo Web/Móvil">Desarrollo y Apps Móviles</option>
            <option value="Otros">General / Múltiples Áreas</option>
        </select>

        <label class="block text-sm font-medium mb-1">Años de Experiencia *</label>
        <input type="number" name="experiencia" class="input-field" min="1" max="50" required placeholder="Mínimo 1 año comprobado">

        <label class="block text-sm font-medium mb-1">Breve Biografía / Servicios (Máx. 200 caracteres) *</label>
        <textarea name="bio" rows="3" class="input-field resize-y" maxlength="200" required placeholder="Experto en diagnóstico, solución remota..."></textarea>

        <p class="text-sm text-gray-400 mt-4 mb-2 font-bold border-t border-gray-700 pt-4">Documentación Obligatoria (Imágenes)</p>
        <label class="block text-sm font-medium mb-1">1. Foto de Identidad (Cédula/DPI) *</label>
        <input type="file" id="id_file" name="id_file" class="input-field" accept="image/png, image/jpeg" required>

        <label class="block text-sm font-medium mb-1">2. Foto Selfie con Identidad *</label>
        <input type="file" id="selfie_file" name="selfie_file" class="input-field" accept="image/png, image/jpeg" required>

        <button type="submit" id="submitButton" class="submit-button">Enviar Solicitud y Documentos</button>
    </form>

    <div id="message-box" role="alert"></div>
</div>

<script>
    const SUPABASE_URL = 'https://hsdhsgyzxalhjdihpuvo.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_HmIKr5aaqK-zxdNM5yiWNQ_G7lSH8XT';
    const BUCKET_NAME = 'tech-documents';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById('techForm');
    const messageBox = document.getElementById('message-box');
    const submitButton = document.getElementById('submitButton');

    function showMessage(msg, type) {
        messageBox.textContent = msg;
        messageBox.style.display = 'block';
        messageBox.className = type;
    }

    function generateUniqueId() {
        const date = new Date();
        const yyyymmdd = date.getFullYear().toString() + String(date.getMonth() + 1).padStart(2, '0') + String(date.getDate()).padStart(2, '0');
        const uuid = crypto.randomUUID().split('-')[0].toUpperCase();
        return `TECH-${yyyymmdd}-${uuid}`;
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        submitButton.disabled = true;
        submitButton.textContent = "Procesando...";
        showMessage("Subiendo archivos...", 'loading');

        const formData = new FormData(form);
        const uniqueTechId = generateUniqueId();
        const idFile = document.getElementById('id_file').files[0];
        const selfieFile = document.getElementById('selfie_file').files[0];

        try {
            const idPath = `${uniqueTechId}/dpi-${Date.now()}.${idFile.name.split('.').pop()}`;
            const selfiePath = `${uniqueTechId}/selfie-${Date.now()}.${selfieFile.name.split('.').pop()}`;

            await supabaseClient.storage.from(BUCKET_NAME).upload(idPath, idFile);
            await supabaseClient.storage.from(BUCKET_NAME).upload(selfiePath, selfieFile);

            const fotoDpiUrl = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(idPath).data.publicUrl;
            const fotoSelfieUrl = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(selfiePath).data.publicUrl;

            const payload = {
                tecnico_id: uniqueTechId,
                nombre: formData.get('nombre'),
                cedula: formData.get('cedula'),
                email: formData.get('email'),
                telefono: formData.get('telefono'),
                paypal: formData.get('paypal'),
                especialidad: formData.get('especialidad'),
                experiencia: parseInt(formData.get('experiencia')),
                bio: formData.get('bio'),
                foto_dpi_url: fotoDpiUrl,
                foto_selfie_url: fotoSelfieUrl,
                status: 'Pendiente de Revisión',
                fecha_registro: new Date().toISOString()
            };

            const { error } = await supabaseClient.from('tecnicos').insert([payload]);
            if (error) throw error;

            // Telegram desde Render (principal – siempre encendido)
            fetch('https://techuit-bot.onrender.com/notificar-nuevo-tecnico', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // Respaldo local (solo si tu PC está encendida)
            fetch('http://localhost:3939/notificar-nuevo-tecnico', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(() => {});

            // Correo automático con logo
            emailjs.send('service_klwxsdr', 'template_stzqgir', {
                to_name: payload.nombre,
                tecnico_id: payload.tecnico_id,
                to_email: payload.email
            });

            showMessage(`¡ÉXITO TOTAL! ID: ${uniqueTechId}`, 'success');
            form.reset();

        } catch (err) {
            showMessage('ERROR: ' + err.message, 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = "Enviar Solicitud y Documentos";
        }
    });
</script>
</body>
</html>