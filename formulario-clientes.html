// archivo: seguimiento_cliente.html (COMPLETO + RESPLANDOR AZUL + FUNCIONA)
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Seguimiento - TechUIT</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{
      font-family:'Inter',sans-serif;margin:0;padding:20px;background:#000;color:#fff;
      min-height:100vh;display:flex;justify-content:center;align-items:flex-start;
    }
    .main-card{
      max-width:440px;width:100%;background:#1a1a1a;padding:2rem 1.5rem;
      border-radius:1.5rem;box-shadow:0 8px 30px rgba(0,123,255,.2);
    }
    .back-btn{display:inline-flex;align-items:center;color:#aaa;text-decoration:none;margin-bottom:1rem;font-size:.95rem;}
    .back-btn:hover{color:#fff;}
    #map{height:66vh;border-radius:12px;overflow:hidden;margin:1.5rem 0;}
    .info{background:#2a2a2a;padding:1rem;border-radius:12px;font-size:.95rem;}
    .label{font-weight:600;color:#60a5fa;}
    .btn{background:#007bff;color:white;padding:.8rem;border-radius:50px;font-weight:700;
         box-shadow:0 6px 20px rgba(0,123,255,.6);width:100%;margin-top:1rem;}
    @media (max-width:768px){#map{height:50vh}}
  </style>
</head>
<body>
  <div class="main-card">
    <a href="index.html" class="back-btn">← Volver</a>
    <h1 class="text-2xl font-bold text-center mb-2">Seguimiento en vivo</h1>
    <p class="text-center text-gray-400 text-sm mb-6">Cuando el técnico esté en camino lo verás aquí</p>

    <div id="map"></div>

    <div class="info">
      <div><span class="label">Cliente:</span> <span id="cliente-nombre">—</span></div>
      <div><span class="label">Estado:</span> <span id="pedido-status">—</span></div>
      <div><span class="label">Técnico:</span> <span id="tecnico-nombre">—</span></div>
      <div><span class="label">Distancia:</span> <span id="distancia">—</span></div>
      <div><span class="label">Actualizado:</span> <span id="ultima">—</span></div>
      <button id="btn-refresh" class="btn">Refrescar ubicación</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = 'https://hsdhsgyzxalhjdihpuvo.supabase.co'
    const SUPABASE_ANON_KEY = 'TU_ANON_KEY_PÚBLICA_AQUÍ'   // ← placeholder seguro

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      realtime: { params: { eventsPerSecond: 10 } }
    });

    // === TU CÓDIGO ORIGINAL DEL MAPA (100 % completo) ===
    function getClientIdFromQuery() {
      const url = new URL(window.location.href);
      const q = url.searchParams.get('client_id') || url.searchParams.get('cliente_id') || url.searchParams.get('id');
      if (q) return q;
      const stored = localStorage.getItem('techuit_client_id');
      if (stored) return stored;
      return null;
    }
    async function promptForClientId() {
      const id = prompt('Introduce tu ID de solicitud:');
      if (id) localStorage.setItem('techuit_client_id', id);
      return id || null;
    }

    let clientId = getClientIdFromQuery();
    (async () => {
      if (!clientId) clientId = await promptForClientId();
      if (!clientId) return alert('ID requerido');
      init();
    })();

    const map = L.map('map').setView([14.6, -87.8], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let clienteMarker = null, tecnicoMarker = null;
    function setClienteMarker(lat,lng){
      if(!clienteMarker) clienteMarker = L.marker([lat,lng],{icon:L.divIcon({html:`<svg width="18" height="18"><circle cx="9" cy="9" r="8" fill="#06b6d4"/></svg>`})}).addTo(map);
      else clienteMarker.setLatLng([lat,lng]);
    }
    function setTecnicoMarker(lat,lng){
      if(!tecnicoMarker) tecnicoMarker = L.marker([lat,lng],{icon:L.divIcon({html:`<svg width="22" height="22"><circle cx="11" cy="11" r="10" fill="#7c3aed"/></svg>`})}).addTo(map);
      else tecnicoMarker.setLatLng([lat,lng]);
    }

    function computeDistanceKm(lat1,lon1,lat2,lon2){
      const toRad=v=>v*Math.PI/180,R=6371,dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    let assignedTecnico=null, currentStatus=null;

    async function loadInitialClient(){
      const {data,error}=await supabase.from('clientes').select('*, tecnicos(*)').eq('id',clientId).maybeSingle();
      if(error||!data){alert('Cliente no encontrado');return;}
      document.getElementById('cliente-nombre').innerText=data.nombre||`Cliente ${data.id}`;
      currentStatus=data.status||'—';
      document.getElementById('pedido-status').innerText=currentStatus;

      if(data.lat_cliente && data.lng_cliente){
        const lat=+data.lat_cliente,lng=+data.lng_cliente;
        if(isFinite(lat)&&isFinite(lng)){setClienteMarker(lat,lng);map.setView([lat,lng],14);}
      }

      if(data.tecnico_asignado_id){
        assignedTecnico = data.tecnicos?.[0] || (await supabase.from('tecnicos').select('*').eq('id',data.tecnico_asignado_id).maybeSingle()).data;
        document.getElementById('tecnico-nombre').innerText = assignedTecnico?.nombre || 'Técnico asignado';
      }

      if(assignedTecnico && ['tecnico_en_camino','tecnico_llego'].includes(currentStatus)){
        const {data:loc}=await supabase.from('tecnico_ubicacion').select('lat_cliente,lng_cliente,updated_at').eq('tecnico_id',assignedTecnico.id).order('updated_at',{ascending:false}).limit(1).maybeSingle();
        if(loc?.lat_cliente && loc?.lng_cliente){
          const lat=+loc.lat_cliente,lng=+loc.lng_cliente;
          setTecnicoMarker(lat,lng);
          if(clienteMarker){
            const c=clienteMarker.getLatLng();
            document.getElementById('distancia').innerText=`${computeDistanceKm(c.lat,c.lng,lat,lng).toFixed(2)} km`;
          }
          document.getElementById('ultima').innerText=loc.updated_at||'—';
        }
      }
    }

    function subscribeRealtime(){
      supabase.channel('tecnico_ubicacion').on('postgres_changes',{event:'*',schema:'public',table:'tecnico_ubicacion'},payload=>{
        const row=payload.new;
        if(!row||!assignedTecnico||String(row.tecnico_id)!==String(assignedTecnico.id))return;
        if(row.lat_cliente && row.lng_cliente){
          const lat=+row.lat_cliente,lng=+row.lng_cliente;
          setTecnicoMarker(lat,lng);
          if(clienteMarker){
            const c=clienteMarker.getLatLng();
            document.getElementById('distancia').innerText=`${computeDistanceKm(c.lat,c.lng,lat,lng).toFixed(2)} km`;
          }
          if(row.updated_at)document.getElementById('ultima').innerText=row.updated_at;
        }
      }).subscribe();

      supabase.channel('clientes').on('postgres_changes',{event:'*',schema:'public',table:'clientes',filter:`id=eq.${clientId}`},payload=>{
        const r=payload.new;
        if(!r)return;
        currentStatus=r.status||currentStatus;
        document.getElementById('pedido-status').innerText=currentStatus;
        if(r.lat_cliente&&r.lng_cliente){setClienteMarker(+r.lat_cliente,+r.lng_cliente);}
      }).subscribe();
    }

    document.getElementById('btn-refresh').addEventListener('click',loadInitialClient);

    async function init(){
      await loadInitialClient();
      subscribeRealtime();
    }
  </script>

  <script>
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>navigator.serviceWorker.register('/TechUIT/service-worker.js').catch(()=>{ }));
    }
  </script>
</body>
</html>