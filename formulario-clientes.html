<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Servicio | TechUIT</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:#000;color:#fff;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:1rem}
        .c{width:100%;max-width:460px;background:#111;padding:2.5rem;border-radius:16px;box-shadow:0 10px 40px rgba(0,100,255,0.2)}
        img{width:70px;margin:0 auto 1.5rem;display:block;filter:invert(1)}
        h1{font-size:1.8rem;font-weight:700;text-align:center;margin-bottom:.5rem}
        p{text-align:center;color:#aaa;font-size:.95rem;margin-bottom:1.5rem}
        input,select,textarea{width:100%;padding:14px;margin-bottom:1rem;background:#222;border:1px solid #333;border-radius:10px;color:#fff;font-size:1rem}
        input:focus,select:focus,textarea:focus{border-color:#007bff;outline:none}
        button{width:100%;padding:16px;background:#007bff;color:#fff;font-weight:600;border:none;border-radius:10px;cursor:pointer;font-size:1.1rem}
        button:hover{background:#0056b3}
        button:disabled{background:#444;cursor:not-allowed}
        .status{text-align:center;color:#60a5fa;margin:1rem 0}
        .hidden{display:none}
        .msg{margin-top:1rem;padding:1rem;border-radius:10px;text-align:center;display:none}
    </style>
</head>
<body>
<div class="c">
    <img src="Logo.png" alt="TechUIT">
    <h1>Solicitud de Servicio Técnico</h1>
    <p>Llená el formulario y un técnico te contacta rápido</p>

    <form id="form">
        <input type="text" id="nombre" placeholder="Nombre completo" required>
        <input type="tel" id="telefono" placeholder="Teléfono" required>
        <input type="text" id="direccion" placeholder="Dirección exacta" required>

        <select id="ciudadManual" class="hidden">
            <option value="">– Elige tu ciudad –</option>
            <option>San Pedro Sula</option><option>Tegucigalpa</option><option>La Ceiba</option>
            <option>Choluteca</option><option>El Progreso</option><option>La Lima</option>
            <option>Puerto Cortés</option><option>Comayagua</option><option>Danlí</option>
            <option>Santa Bárbara</option><option>Juticalpa</option><option>Siguatepeque</option>
            <option>Roatán</option>
        </select>

        <p id="status" class="status">Detectando ubicación...</p>

        <select id="servicio" required>
            <option value="" disabled selected>Tipo de servicio</option>
            <option>Reparación de Hardware</option>
            <option>Mantenimiento de Software</option>
            <option>Configuración de Redes</option>
            <option>Eliminación de Virus/Malware</option>
            <option>Soporte Remoto</option>
            <option>Otro</option>
        </select>

        <textarea id="problema" rows="4" placeholder="Describe el problema" maxlength="400" required></textarea>
        <input type="hidden" id="ciudad">

        <button type="submit" id="btn">Solicitar Técnico Ahora</button>
    </form>
    <div id="msg" class="msg"></div>
</div>

<script type="module">
    const supabase = window.supabase.createClient(
        'https://hsdhsgyzxalhjdihpuvo.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzZGhzZ3l6eGFsaGpkaWhwdXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODA5NDQsImV4cCI6MjA3NDc1Njk0NH0.0KDQV2032sxJZ0y2srvQi4hLe496uhLman9Nb3aqhJc'
    );

    const CIUDADES = ['San Pedro Sula','Tegucigalpa','La Ceiba','Choluteca','El Progreso','La Lima','Puerto Cortés','Comayagua','Danlí','Santa Bárbara','Juticalpa','Siguatepeque','Roatán'];
    let ciudad = null;

    const status = document.getElementById('status');
    const ciudadManual = document.getElementById('ciudadManual');
    const ciudadInput = document.getElementById('ciudad');

    // GPS
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
            const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&format=json`);
            const d = await r.json();
            const c = d.address?.city || d.address?.town || d.address?.state || '';
            const norm = c.toLowerCase();
            const encontrada = CIUDADES.find(ci => norm.includes(ci.toLowerCase().replace('á','a').replace('í','i')));
            if (encontrada) {
                ciudad = encontrada;
                ciudadInput.value = ciudad;
                status.innerHTML = `<strong>${ciudad}</strong>`;
            } else fallback();
        }, fallback, {timeout:10000});
    } else fallback();

    function fallback() {
        status.textContent = 'Elige tu ciudad:';
        ciudadManual.classList.remove('hidden');
        ciudadManual.onchange = () => {
            ciudad = ciudadManual.value;
            ciudadInput.value = ciudad;
        };
    }

    // ENVÍO
    document.getElementById('form').onsubmit = async e => {
        e.preventDefault();
        if (!ciudad && !ciudadManual.value) return alert('Elige ciudad');
        document.getElementById('btn').disabled = true;
        document.getElementById('btn').textContent = 'Enviando...';

        const data = {
            nombre: document.getElementById('nombre').value,
            telefono: document.getElementById('telefono').value,
            direccion: document.getElementById('direccion').value,
            tipo_servicio: document.getElementById('servicio').value,
            problema: document.getElementById('problema').value,
            ciudad: ciudad || ciudadManual.value,
            status: 'Pendiente'
        };

        const {error} = await supabase.from('clientes').insert([data]);
        if (error) {
            alert('Error: '+error.message);
        } else {
            alert('¡Solicitud enviada! Te contactamos pronto');
            window.location.href = 'confirmacion-pago.html?solicitud=nuevo';
        }
        document.getElementById('btn').disabled = false;
        document.getElementById('btn').textContent = 'Solicitar Técnico Ahora';
    };
</script>
</body>
</html>