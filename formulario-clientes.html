<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Clientes (Servicios Informáticos)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Supabase SDK para la base de datos -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        /* Estilos generales oscuros */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #fff;
            padding: 20px 10px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        .form-container {
            width: 100%;
            max-width: 450px;
            background-color: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 123, 255, 0.2); 
        }
        h1 {
            color: #007bff; /* Azul primario */
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            text-align: center;
        }
        .subtitle {
            color: #ccc;
            margin-bottom: 25px;
            text-align: center;
        }
        .input-field {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            margin-bottom: 15px;
            background-color: #2a2a2a;
            border: 1px solid #374151;
            border-radius: 8px;
            color: #fff;
            box-sizing: border-box;
            resize: none; 
            transition: border-color 0.3s;
        }
        .input-field:focus {
            border-color: #007bff; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
        }
        .submit-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(145deg, #007bff, #0056b3);
            color: #fff;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.6);
            margin-top: 20px;
        }
        .submit-button:hover {
            background: linear-gradient(145deg, #0056b3, #007bff);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.7);
        }
        .submit-button:disabled {
            background: #505050;
            cursor: not-allowed;
            box-shadow: none;
        }
        #message-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .success { background-color: #16a34a; color: #fff; }
        .error { background-color: #dc2626; color: #fff; }
        .loading { background-color: #f59e0b; color: #fff; }
    </style>
</head>
<body>

<div class="form-container">
    <h1>Solicitud de Servicio Informático</h1>
    <p class="subtitle">Usando las columnas exactas de su tabla: 'nombre', 'telefono', 'problema', etc.</p>

    <!-- FORMULARIO PRINCIPAL DE REGISTRO DE CLIENTES -->
    <form id="clientForm">
        
        <!-- Columna: "nombre" -->
        <label for="nombre" class="block text-sm font-medium mb-1">Nombre Completo *</label>
        <input type="text" id="nombre" name="nombre" class="input-field" required placeholder="Su nombre">

        <!-- Correo Electrónico (Solo para UX, no se envía a la DB) -->
        <label for="email_cliente" class="block text-sm font-medium mb-1">Correo Electrónico</label>
        <input type="email" id="email_cliente" name="email_cliente" class="input-field" placeholder="ejemplo@casa.com">

        <!-- Columna: "telefono" -->
        <label for="telefono" class="block text-sm font-medium mb-1">Teléfono (WhatsApp) *</label>
        <input type="tel" id="telefono" name="telefono" class="input-field" required placeholder="+555...">
        
        <!-- Columna: "tipo_servicio" - CORREGIDO A OPCIONES INFORMÁTICAS -->
        <label for="tipo_servicio" class="block text-sm font-medium mb-1">Tipo de Servicio Informático *</label>
        <select id="tipo_servicio" name="tipo_servicio" class="input-field" required>
            <option value="" disabled selected>Selecciona el área de TI</option>
            <option value="Soporte Tecnico">Soporte Técnico (Hardware/Software)</option>
            <option value="Desarrollo Web">Desarrollo Web / Aplicaciones</option>
            <option value="Redes">Redes y Conectividad</option>
            <option value="Recuperacion Datos">Recuperación de Datos</option>
            <option value="Ciberseguridad">Ciberseguridad / Protección</option>
            <option value="Mantenimiento Preventivo">Mantenimiento Preventivo</option>
        </select>
        
        <!-- Columna: "direccion" -->
        <label for="direccion" class="block text-sm font-medium mb-1">Dirección de Servicio / Ubicación *</label>
        <input type="text" id="direccion" name="direccion" class="input-field" required placeholder="Calle, número, colonia/barrio">

        <!-- Columna: "problema" -->
        <label for="problema" class="block text-sm font-medium mb-1">Descripción Detallada del Problema *</label>
        <textarea id="problema" name="problema" class="input-field h-24" required placeholder="Ej: La computadora no arranca o la red tiene fallas..."></textarea>
        
        <button type="submit" id="submitButton" class="submit-button">Solicitar Técnico Ahora</button>
    </form>

    <div id="message-box" role="alert"></div>

</div>

<!-- SCRIPT DE CONECTIVIDAD SUPABASE CON ESQUEMA CORREGIDO -->
<script>
    // **********************************************
    // 1. CONFIGURACIÓN DE SUPABASE (Claves que usted proporcionó)
    // **********************************************
    const SUPABASE_URL = 'https://hsdhsgyzxalhjdihpuvo.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzZGhzZ3l6eGFsaGpkaWhwdXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODA5NDQsImV4cCI6MjA3NDc1Njk0NH0.0KDQV2032sxJZ0y2srvQi4hLe496uhLman9Nb3aqhJc'; 
    
    let supabaseClient = null;
    const form = document.getElementById('clientForm');
    const messageBox = document.getElementById('message-box');
    const submitButton = document.getElementById('submitButton');

    // Función auxiliar para mostrar mensajes
    function showMessage(message, type) {
        messageBox.textContent = message;
        messageBox.style.display = 'block';
        messageBox.classList.remove('success', 'error', 'loading');
        messageBox.classList.add(type);
    }

    // Inicialización de Supabase
    try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (error) {
        showMessage('Error al inicializar Supabase. Verifique las claves.', 'error');
    }

    // Lógica principal de envío
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!supabaseClient) {
                showMessage("Error: Conexión a Supabase inactiva.", 'error');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = "Guardando solicitud...";
            showMessage("Enviando datos a la base de datos...", 'loading');

            const formData = new FormData(form);

            // 2. PAYLOAD DE DATOS - COINCIDE 100% CON SU ESQUEMA
            const payloadData = {
                // Columna: "nombre" (text)
                nombre: formData.get('nombre'),
                // Columna: "telefono" (text)
                telefono: formData.get('telefono'),
                // Columna: "tipo_servicio" (text) - Contiene el nuevo valor IT
                tipo_servicio: formData.get('tipo_servicio'),
                // Columna: "direccion" (text)
                direccion: formData.get('direccion'),
                // Columna: "problema" (text)
                problema: formData.get('problema'),
                
                // Columna: "status" (text)
                status: 'Pendiente - Pago Diagnóstico', 
                
                // Columna: "fecha_solicitud" (timestamp with time zone)
                fecha_solicitud: new Date().toISOString()
            };

            // 3. Envío de Datos a la tabla 'clientes'
            try {
                const { error, data } = await supabaseClient
                    .from('clientes') 
                    .insert([payloadData])
                    .select();

                if (error) {
                    let errorMessage = `🔴 FALLO: Código Supabase: ${error.code}.`;
                    
                    if (error.code === '23502') {
                        errorMessage = "🔴 ¡ERROR DE COLUMNA! Le falta un campo obligatorio (NOT NULL).";
                    } else if (error.code === '42501') {
                         errorMessage = "🔴 ¡ERROR RLS! Se deniega el permiso. Verifique las políticas de seguridad de su base de datos.";
                    } else {
                        errorMessage = `🔴 ¡FALLO DESCONOCIDO! Revise la consola (F12) para ver el mensaje completo: ${error.message}`;
                    }

                    showMessage(errorMessage, 'error');
                    console.error("Supabase Error Completo:", error);

                } else {
                    const id = data && data.length > 0 ? data[0].id : 'N/A';
                    showMessage(`✅ ¡Solicitud registrada con éxito! ID: ${id}`, 'success');
                    form.reset();
                }

            } catch (error) {
                showMessage("ERROR DE CONEXIÓN DE RED: Fallo al contactar a Supabase.", 'error');
                console.error("Error de Fetch o Desconocido:", error);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = "Solicitar Técnico Ahora";
            }
        });
    }

</script>
</body>
</html>
