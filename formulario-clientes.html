<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ANTI-CACHÉ PARA SIEMPRE -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Solicitud de Servicio | TechUIT</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:#000;color:#fff;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:1rem}
        .c{max-width:460px;width:100%;background:#111;padding:2.5rem;border-radius:16px;box-shadow:0 10px 40px rgba(0,100,255,.2)}
        .logo{width:80px;margin:0 auto 1.5rem;display:block}
        h1{font-size:1.9rem;font-weight:700;text-align:center;margin-bottom:.5rem}
        p{text-align:center;color:#aaa;font-size:.95rem;margin-bottom:1.8rem}
        input,select,textarea{width:100%;padding:14px;margin-bottom:1rem;background:#222;border:1px solid #333;border-radius:10px;color:#fff;font-size:1rem}
        input:focus,select:focus,textarea:focus{border-color:#007bff;outline:none}
        button{width:100%;padding:16px;background:#007bff;color:#fff;font-weight:600;border:none;border-radius:10px;cursor:pointer;font-size:1.1rem}
        button:hover{background:#0056b3}
        button:disabled{background:#444;cursor:not-allowed}
        .status{text-align:center;color:#60a5fa;margin:1rem 0}
        .hidden{display:none}
        .msg{margin-top:1rem;padding:1rem;background:#0a3d0a;border-radius:10px;text-align:center;color:#90ee90;display:none}
    </style>
</head>
<body>
<div class="c">
    <img src="Logo.png" alt="TechUIT" class="logo">
    <h1>Solicitud de Servicio Técnico</h1>
    <p>Llena el formulario y un técnico te contactará en minutos</p>

    <form id="form">
        <input type="text" id="nombre" placeholder="Nombre completo" required>
        <input type="tel" id="telefono" placeholder="Teléfono" required>
        <input type="text" id="direccion" placeholder="Dirección exacta" required>

        <select id="ciudadManual" class="hidden">
            <option value="">– Elige tu ciudad –</option>
            <option>San Pedro Sula</option><option>Tegucigalpa</option><option>La Ceiba</option>
            <option>Choluteca</option><option>El Progreso</option><option>La Lima</option>
            <option>Puerto Cortés</option><option>Comayagua</option><option>Danlí</option>
            <option>Santa Bárbara</option><option>Juticalpa</option><option>Siguatepeque</option>
            <option>Roatán</option>
        </select>

        <p id="status" class="status">Detectando ubicación...</p>

        <select id="servicio" required>
            <option value="" disabled selected>Tipo de servicio</option>
            <option>Reparación de Hardware</option>
            <option>Mantenimiento de Software</option>
            <option>Configuración de Redes</option>
            <option>Eliminación de Virus/Malware</option>
            <option>Soporte Remoto</option>
            <option>Otro</option>
        </select>

        <textarea id="problema" rows="4" placeholder="Describe el problema" maxlength="400" required></textarea>
        <input type="hidden" id="ciudad">
        <button type="submit" id="btn">Solicitar Técnico Ahora</button>
    </form>

    <div id="msg" class="msg"></div>
</div>

<script type="module">
    const supabase = window.supabase.createClient('https://hsdhsgyzxalhjdihpuvo.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzZGhzZ3l6eGFsaGpkaWhwdXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODA5NDQsImV4cCI6MjA3NDc1Njk0NH0.0KDQV2032sxJZ0y2srvQi4hLe496uhLman9Nb3aqhJc');

    const CIUDADES = ['San Pedro Sula','Tegucigalpa','La Ceiba','Choluteca','El Progreso','La Lima','Puerto Cortés','Comayagua','Danlí','Santa Bárbara','Juticalpa','Siguatepeque','Roatán'];
    let ciudad = null;
    const status = document.getElementById('status');
    const ciudadManual = document.getElementById('ciudadManual');
    const ciudadInput = document.getElementById('ciudad');
    const msg = document.getElementById('msg');

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
            const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&format=json&zoom=10`);
            const d = await r.json();
            const c = d.address?.city || d.address?.town || '';
            const encontrada = CIUDADES.find(x => c.toLowerCase().includes(x.toLowerCase().replace('á','a')));
            if (encontrada) { ciudad = encontrada; ciudadInput.value = ciudad; status.innerHTML = `<strong>${ciudad}</strong>`; return; }
            fallback();
        }, fallback);
    } else fallback();

    function fallback() {
        status.textContent = 'Elige tu ciudad:';
        ciudadManual.classList.remove('hidden');
        ciudadManual.onchange = () => { ciudad = ciudadManual.value; ciudadInput.value = ciudad; };
    }

    document.getElementById('form').onsubmit = async e => {
        e.preventDefault();
        if (!ciudad && !ciudadManual.value) return;

        const btn = document.getElementById('btn');
        btn.disabled = true;
        btn.textContent = 'Enviando...';

        const payload = {
            nombre: document.getElementById('nombre').value.trim(),
            telefono: document.getElementById('telefono').value.trim(),
            direccion: document.getElementById('direccion').value.trim(),
            tipo_servicio: document.getElementById('servicio').value,
            problema: document.getElementById('problema').value.trim(),
            ciudad: ciudad || ciudadManual.value,
            status: 'Pendiente'
        };

        const { data, error } = await supabase.from('clientes').insert([payload]).select();

        btn.disabled = false;
        btn.textContent = 'Solicitar Técnico Ahora';

        if (error) {
            msg.style.display = 'block';
            msg.style.background = '#3d0a0a';
            msg.textContent = 'Error: ' + error.message;
        } else {
            const id = data[0].id;
            msg.style.display = 'block';
            msg.textContent = `¡Solicitud #${id} enviada con éxito! Redirigiendo al pago...`;
            setTimeout(() => location.href = `confirmacion-pago.html?solicitud=${id}`, 2000);
        }
    };
</script>

<!-- ANTI-CACHÉ FINAL -->
<script>document.documentElement.setAttribute('data-build', new Date().getTime());</script>
</body>
</html>