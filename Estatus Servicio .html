<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatus de Servicio  | TechUIT</title>
    <!-- Carga de Supabase SDK y Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- ESTILOS DE LUJO Y CONSISTENTES --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --color-dark-bg: #000;      
            --color-card-bg: #1a1a1a;   
            --color-primary: #007bff;   
            --color-text-light: #f3f4f6;
            --color-success: #25D366;
            --color-danger: #ff4d4d;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--color-dark-bg);
            color: var(--color-text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .main-card {
            max-width: 440px;
            width: 100%;
            padding: 24px;
            background-color: var(--color-card-bg);
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #30363d;
        }
        
        input[type="text"] {
            background-color: #0d1117;
            border: 2px solid #30363d;
            color: var(--color-text-light);
            padding: 18px; 
            font-size: 1.25rem;
            font-weight: 700;
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #ffc107; /* Foco amarillo */
        }
    </style>
</head>
<body>

<div class="main-card">
    <header class="text-center mb-6">
        <h1 class="text-3xl font-extrabold text-yellow-400 mb-1">
            Estatus de Servicio VIP
        </h1>
        <p class="text-sm text-gray-400">
            Ingresa tu C√≥digo √önico (ID) para verificar tu clasificaci√≥n.
        </p>
    </header>

    <div id="form-container" class="space-y-6">
        
        <div>
            <label for="solicitud-code" class="block text-sm font-medium mb-2 text-white">
                C√ìDIGO √öNICO DE SOLICITUD
            </label>
            <input type="text" id="solicitud-code" placeholder="Pega tu ID aqu√≠ (Ej: X9H7Z)" class="w-full uppercase text-center" required>
        </div>
        
        <button id="check-status-button"
            class="w-full bg-blue-600 text-white font-extrabold py-4 rounded-lg hover:bg-blue-700 transition duration-200 ease-in-out transform hover:scale-[1.01] shadow-lg shadow-blue-500/40 text-xl"
        >
            VER ESTADO DE MI SERVICIO
        </button>

        <div id="status-display" class="mt-8 p-4 rounded-lg hidden">
            <h3 id="status-title" class="text-xl font-bold mb-2"></h3>
            <p id="status-detail" class="text-sm"></p>
        </div>

        <p id="message-container" class="text-center mt-4 font-semibold text-white"></p>
    </div>
</div>

<script type="module">
    // *** CONFIGURACI√ìN CR√çTICA DE SUPABASE (CORREGIDA) ***
    const SUPABASE_URL = 'https://hsdhsgyzxalhjdihpuvo.supabase.co '; // ¬°IMPORTANTE: Reemplazar!
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzZGhzZ3l6eGFsaGpkaWhwdXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODA5NDQsImV4cCI6MjA3NDc1Njk0NH0.0KDQV2032sxJZ0y2srvQi4hLe496uhLman9Nb3aqhJc'; // ¬°IMPORTANTE: Reemplazar!
    const REQUESTS_TABLE = 'service_requests';
    
    // Inicializaci√≥n Corregida del Cliente Supabase
    let supabase = null;
    if (SUPABASE_URL !== 'https://hsdhsgyzxalhjdihpuvo.supabase.co ') {
        supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        document.getElementById('message-container').textContent = '‚ö†Ô∏è ERROR CR√çTICO: Configuraci√≥n de Supabase no definida.';
        document.getElementById('message-container').classList.add('text-red-500');
    }

    const solicitudCodeInput = document.getElementById('solicitud-code');
    const checkStatusButton = document.getElementById('check-status-button');
    const messageContainer = document.getElementById('message-container');
    const statusDisplay = document.getElementById('status-display');
    const statusTitle = document.getElementById('status-title');
    const statusDetail = document.getElementById('status-detail');


    checkStatusButton.addEventListener('click', async () => {
        const solicitudCode = solicitudCodeInput.value.trim().toUpperCase();
        
        if (!supabase) {
             messageContainer.textContent = "üî¥ ERROR: La aplicaci√≥n no est√° conectada al servidor.";
             messageContainer.className = 'text-center mt-4 font-semibold text-red-500';
             return;
        }

        if (!solicitudCode) {
            messageContainer.textContent = "üî¥ Ingresa tu C√≥digo √önico (ID).";
            messageContainer.className = 'text-center mt-4 font-semibold text-red-500';
            statusDisplay.classList.add('hidden');
            return;
        }

        checkStatusButton.disabled = true;
        checkStatusButton.textContent = "VERIFICANDO ESTATUS...";
        messageContainer.textContent = '';
        statusDisplay.classList.add('hidden');

        try {
            // Buscamos la solicitud con el c√≥digo (ID)
            const { data, error } = await supabase
                .from(REQUESTS_TABLE)
                .select('id, status, payment_verified, assigned_technician_id')
                .eq('id', solicitudCode) 
                .limit(1);

            if (error) throw new Error(error.message);

            if (data && data.length > 0) {
                const request = data[0];
                
                // L√≥gica de visualizaci√≥n de estado
                statusDisplay.classList.remove('hidden');

                if (request.payment_verified) {
                    // PAGO CONFIRMADO por el Admin (t√∫)
                    statusDisplay.className = 'mt-8 p-4 rounded-lg bg-green-900 border border-green-500';
                    statusTitle.textContent = "‚úÖ CLASIFICADO: T√©cnico Asignado";
                    statusTitle.classList.add('text-green-400');
                    
                    if (request.assigned_technician_id) {
                        statusDetail.textContent = `¬°Tu servicio ya fue asignado! ID del T√©cnico: ${request.assigned_technician_id}. Te contactar√°n pronto.`;
                    } else {
                        statusDetail.textContent = "Pago verificado. Estamos buscando al mejor t√©cnico disponible en tu zona (m√°ximo 15 minutos).";
                    }
                    
                } else if (request.status === 'PAGO_EN_CURSO') {
                    // Cliente fue a pagar, pero Admin no ha verificado (Estado Manual)
                    statusDisplay.className = 'mt-8 p-4 rounded-lg bg-yellow-900 border border-yellow-500';
                    statusTitle.textContent = "‚è≥ VERIFICACI√ìN PENDIENTE";
                    statusTitle.classList.add('text-yellow-400');
                    statusDetail.textContent = "Hemos recibido la solicitud. Estamos verificando el pago en Kofi (recuerda que este proceso es manual y puede tardar de 5 a 10 minutos).";
                    
                } else {
                    // Estado Inicial o no pagado
                    statusDisplay.className = 'mt-8 p-4 rounded-lg bg-gray-700 border border-gray-500';
                    statusTitle.textContent = "üü† SOLICITUD EN PROCESO";
                    statusTitle.classList.add('text-gray-400');
                    statusDetail.textContent = "Se gener√≥ el ID, pero el pago a√∫n no se registra. Aseg√∫rate de haber completado la transacci√≥n en Kofi con el ID como nota.";
                }

            } else {
                // No hay solicitud con ese c√≥digo.
                messageContainer.textContent = "üî¥ ERROR: C√≥digo de Solicitud no v√°lido o inexistente.";
                messageContainer.className = 'text-center mt-4 font-semibold text-red-500';
                statusDisplay.classList.add('hidden');
            }

        } catch (error) {
            console.error("Fallo al verificar servicio:", error);
            messageContainer.textContent = `üî¥ ERROR DEL SISTEMA: ${error.message}.`;
            messageContainer.className = 'text-center mt-4 font-semibold text-red-500';
        }

        checkStatusButton.disabled = false;
        checkStatusButton.textContent = "VER ESTADO DE MI SERVICIO";
    });

</script>
</body>
</html>
