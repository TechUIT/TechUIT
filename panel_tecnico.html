<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Técnico</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">
  <div class="max-w-md mx-auto bg-gray-800 rounded-xl p-6">
    <input type="email" id="email" placeholder="email técnico" class="w-full p-3 rounded bg-gray-700 mb-4">
    <button onclick="login()" class="w-full bg-blue-600 p-3 rounded font-bold">Entrar</button>

    <div id="panel" class="hidden mt-6">
      <h2 class="text-2xl font-bold mb-4">Hola <span id="nombre"></span></h2>
      <button onclick="gps()" id="gpsbtn" class="w-full bg-green-600 p-3 rounded font-bold mb-4">Iniciar GPS</button>
      <div id="map" class="h-80 rounded-xl mb-4"></div>
      <div id="ordenes"></div>
    </div>
  </div>

<script>
  const { createClient } = supabase
  const supabase = createClient('https://hsdhsgyzxalhjdihpuvo.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzZGhzZ3l6eGFsaGpkaWhwdXZvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTE4MDk0NCwiZXhwIjoyMDc0NzU2OTQ0fQ.0KDQV2032sxJZ0y2srvQi4hLe496uhLman9Nb3aqhJc')

  let watchId = null, tecnicoId

  async function login() {
    const email = document.getElementById('email').value.trim()
    const { data } = await supabase.from('tecnicos').select('id,nombre').eq('email', email).single()
    if (!data) return alert('Técnico no encontrado')
    tecnicoId = data.id
    document.getElementById('nombre').textContent = data.nombre
    document.getElementById('email').remove()
    document.querySelector('button[onclick="login()"]').remove()
    document.getElementById('panel').classList.remove('hidden')
    initMap()
    cargarOrdenes()
  }

  function initMap() {
    const map = L.map('map').setView([15.5, -88], 8)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)
    window.map = map
  }

  function gps() {
    if (watchId) {
      navigator.geolocation.clearWatch(watchId)
      watchId = null
      document.getElementById('gpsbtn').textContent = 'Iniciar GPS'
      return
    }
    watchId = navigator.geolocation.watchPosition(pos => {
      const { latitude: lat, longitude: lng } = pos.coords
      supabase.from('tecnico_ubicacion').upsert({ tecnico_id: tecnicoId, lat, lng })
    }, null, { enableHighAccuracy: true })
    document.getElementById('gpsbtn').textContent = 'Detener GPS'
  }

  async function cargarOrdenes() {
    const { data: disp } = await supabase.from('clientes').select('id,nombre,ciudad').eq('status','pagado_verificado').is('tecnico_asignado_id',null)
    const { data: mios } = await supabase.from('clientes').select('id,status').eq('tecnico_asignado_id',tecnicoId)

    document.getElementById('ordenes').innerHTML = `
      <h3 class="font-bold text-lg mb-2">Disponibles</h3>
      ${disp?.map(o => `<div class="bg-gray-700 p-3 rounded mb-2">${o.nombre} - ${o.ciudad} <button onclick="aceptar(${o.id})" class="bg-green-600 px-3 py-1 rounded text-sm">Aceptar</button></div>`).join('') || '<p class="text-gray-400">Ninguna</p>'}
      <h3 class="font-bold text-lg mb-2 mt-6">Mis órdenes</h3>
      ${mios?.map(o => `<div class="bg-gray-700 p-3 rounded mb-2">ID ${o.id} - ${o.status} 
        ${o.status==='tecnico_asignado' ? `<button onclick="enCamino(${o.id})" class="bg-yellow-600 px-3 py-1 rounded text-sm">En camino</button>` : ''}
        ${o.status==='tecnico_en_camino' ? `<button onclick="llegue(${o.id})" class="bg-yellow-600 px-3 py-1 rounded text-sm">Llegué</button>` : ''}
      </div>`).join('') || '<p class="text-gray-400">Ninguna</p>'}
    `
  }

  async function aceptar(id) { await supabase.from('clientes').update({tecnico_asignado_id: tecnicoId, status:'tecnico_asignado'}).eq('id',id); cargarOrdenes() }
  async function enCamino(id) { await supabase.from('clientes').update({status:'tecnico_en_camino'}).eq('id',id); cargarOrdenes() }
  async function llegue(id) { await supabase.from('clientes').update({status:'tecnico_llego'}).eq('id',id); cargarOrdenes() }
</script>
</body>
</html>