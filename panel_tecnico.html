<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>Panel Técnico - TechUIT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { background:#0d1117; color:#f3f4f6; margin:0; }
    .gradient-blue { background: linear-gradient(90deg, #007bff, #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .active-tab { background:#007bff !important; color:white !important; }
    .offline { background: #450a0a; border: 1px solid #7f1d1d; padding: 12px; border-radius: 12px; text-align: center; margin: 12px; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-lg mx-auto p-4">
    <div class="bg-[#161b22] border border-[#30363d] rounded-3xl p-6 mb-6 shadow-2xl shadow-blue-500/20 text-center">
      <h1 class="text-3xl font-black gradient-blue" id="nombre">Cargando...</h1>
      <a href="login_tecnico.html" onclick="localStorage.clear()" class="text-cyan-400 text-sm underline">Cerrar sesión</a>
    </div>
    <div id="offline-banner" class="offline hidden mb-4">
      <p class="text-red-400 font-bold">Sin conexión → reintentando...</p>
    </div>

    <!-- CAFECITO TÉCNICO -->
    <div id="support-card" class="bg-gradient-to-br from-cyan-900 via-blue-900 to-black rounded-3xl p-10 text-center shadow-2xl border border-cyan-700 mb-6" style="display:none">
      <h3 class="text-4xl font-black gradient-blue mb-6">¡Gran trabajo, crack!</h3>
      <p class="text-xl text-gray-200 mb-8 leading-relaxed">
        Gracias a técnicos como vos TechUIT existe y mejora todos los días.<br>
        ¿Querés apoyar a <strong>TechUIT</strong> con un cafecito?
      </p>
      <div class="flex justify-center gap-6">
        <button id="btn-cafecito" class="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-400 hover:to-red-500 text-white font-bold text-xl py-6 px-14 rounded-full shadow-2xl transform hover:scale-110 transition">
          Sí, invitar un café
        </button>
        <button onclick="document.getElementById('support-card').style.display='none'" class="text-gray-400 hover:text-white underline text-lg">
          Ahora no, gracias
        </button>
      </div>
      <div id="kofi-container" class="mt-10 hidden rounded-2xl overflow-hidden shadow-2xl">
        <iframe src='https://ko-fi.com/techuit/?hidefeed=true&widget=true&embed=true&preview=true' style='border:none;width:100%;padding:4px;background:#f9f9f9;' height='712' title='techuit'></iframe>
      </div>
    </div>

    <div id="map" class="h-96 rounded-3xl overflow-hidden shadow-2xl shadow-blue-500/40 mb-6"></div>
    <div class="flex mb-6">
      <button id="tab-disp" class="flex-1 py-4 rounded-l-3xl font-bold bg-[#161b22] border border-[#30363d] text-white">Disponibles</button>
      <button id="tab-act" class="flex-1 py-4 rounded-r-3xl font-bold bg-[#161b22] border border-[#30363d] text-white">Cliente Actual</button>
    </div>
    <div id="lista" class="space-y-4"></div>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
const supabase = createClient('https://hsdhsgyzxalhjdihpuvo.supabase.co', 'sb_publishable_HmIKr5aaqK-zxdNM5yiWNQ_G7lSH8XT')

const tecnicoId = Number(localStorage.getItem('tecnico_id'))
if (!tecnicoId) location.href = 'login_tecnico.html'
document.getElementById('nombre').textContent = localStorage.getItem('tecnico_nombre') || 'Técnico'

const map = L.map('map').setView([15.507, -88.025], 14)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)

let miMarker = null
let clienteMarker = null
let tab = 0
let estaOffline = false

window.addEventListener('online', () => {
  document.getElementById('offline-banner').classList.add('hidden')
  estaOffline = false
})
window.addEventListener('offline', () => {
  document.getElementById('offline-banner').classList.remove('hidden')
  estaOffline = true
})

// GPS DEL TÉCNICO
function actualizarMiGPS() {
  if (estaOffline) return
  navigator.geolocation.getCurrentPosition(
    pos => {
      const { latitude, longitude } = pos.coords
      supabase.from('tecnico_ubicacion').upsert({
        tecnico_id: tecnicoId,
        lat: latitude,
        lng: longitude,
        updated_at: new Date().toISOString()
      }, { onConflict: 'tecnico_id' })

      if (!miMarker) {
        miMarker = L.circleMarker([latitude, longitude], {
          color: '#00ffff', weight: 7, fillColor: '#00ffff', fillOpacity: 0.3, radius: 32
        }).addTo(map).bindPopup('TÚ (Técnico)').openPopup()
      }
      miMarker.setLatLng([latitude, longitude])
      if (!clienteMarker) map.setView([latitude, longitude], 16)
    },
    () => {},
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  )
}
setInterval(actualizarMiGPS, 8000)
actualizarMiGPS()

async function refresh() {
  if (estaOffline) return

  // Tabs
  document.getElementById('tab-disp').className = tab === 0 ? 'flex-1 py-4 rounded-l-3xl font-bold active-tab' : 'flex-1 py-4 rounded-l-3xl font-bold bg-[#161b22] border border-[#30363d] text-white'
  document.getElementById('tab-act').className = tab === 1 ? 'flex-1 py-4 rounded-r-3xl font-bold active-tab' : 'flex-1 py-4 rounded-r-3xl font-bold bg-[#161b22] border border-[#30363d] text-white'

  const { data: clienteActivo } = await supabase.from('clientes')
    .select('*')
    .eq('tecnico_asignado_id', tecnicoId)
    .not('status', 'ilike', '%Completado%')
    .maybeSingle()

  // MARCADOR DEL CLIENTE — NUNCA MÁS DESAPARECE
  if (clienteActivo) {
    const latCliente = clienteActivo.lat_cliente ?? clienteActivo.lat ?? 15.507
    const lngCliente = clienteActivo.lng_cliente ?? clienteActivo.lng ?? -88.025

    if (!clienteMarker) {
      clienteMarker = L.circleMarker([latCliente, lngCliente], {
        color: '#00ff00', weight: 8, fillColor: '#00ff00', fillOpacity: 0.3, radius: 50
      }).addTo(map).bindPopup(`${clienteActivo.nombre} (Cliente)`)
    }
    clienteMarker.setLatLng([latCliente, lngCliente])

    // SI YA LLEGASTE → CLIENTE ENCIMA TUYO
    if (clienteActivo.status?.includes('llegad') || clienteActivo.status?.includes('llegado')) {
      if (miMarker) {
        const miPos = miMarker.getLatLng()
        clienteMarker.setLatLng(miPos)
        map.setView(miPos, 17)
      }
    }
    // EN CAMINO → CENTRAR AMBOS
    else if (tab === 1 && miMarker) {
      const bounds = L.latLngBounds([miMarker.getLatLng(), clienteMarker.getLatLng()])
      map.fitBounds(bounds, { padding: [50, 50] })
    }
  } else if (clienteMarker) {
    map.removeLayer(clienteMarker)
    clienteMarker = null
  }

  // LISTA DE CLIENTES
  const lista = document.getElementById('lista')
  lista.innerHTML = ''

  if (tab === 0 && !clienteActivo) {
    const { data: disponibles } = await supabase.from('clientes')
      .select('*')
      .or('status.ilike.%verificado%,status.ilike.%pagado%')
      .is('tecnico_asignado_id', null)
      .limit(20)

    if (!disponibles || disponibles.length === 0) {
      lista.innerHTML = '<p class="text-center text-gray-500 py-16 text-xl">No hay clientes disponibles</p>'
    } else {
      disponibles.forEach(c => {
        lista.innerHTML += `
          <div class="bg-[#161b22] border border-[#30363d] rounded-3xl p-6 shadow-xl">
            <h3 class="text-2xl font-bold text-green-400">${c.nombre}</h3>
            <p class="text-gray-400">${c.ciudad || 'Sin ciudad'}</p>
            <button onclick="aceptar(${c.id})" class="w-full mt-4 py-5 bg-green-600 hover:bg-green-500 text-white font-bold text-xl rounded-2xl shadow-lg">
              ACEPTAR TRABAJO
            </button>
          </div>`
      })
    }
  }

  if (clienteActivo) {
    if (tab === 0) {
      lista.innerHTML = '<div class="text-center py-12 bg-orange-900/50 border border-orange-600 rounded-3xl"><h3 class="text-orange-400 text-2xl font-bold">Estás ocupado</h3><p class="text-gray-300 mt-2">Ve a "Cliente Actual"</p></div>'
    }
    if (tab === 1) {
      lista.innerHTML = `
        <div class="bg-[#161b22] border border-[#30363d] rounded-3xl p-8 shadow-2xl">
          <h2 class="text-3xl font-bold text-green-400 mb-6">${clienteActivo.nombre} (#${clienteActivo.id})</h2>
          <div class="space-y-4 text-gray-300 text-lg">
            <p><strong>Dirección:</strong> ${clienteActivo.direccion || '—'}</p>
            <p><strong>Teléfono:</strong> ${clienteActivo.telefono || '—'}</p>
            <p><strong>Problema:</strong> ${clienteActivo.problema || '—'}</p>
          </div>
          ${!clienteActivo.status?.includes('llegad') ? `<button onclick="llegada(${clienteActivo.id})" class="w-full mt-8 py-6 bg-gradient-to-r from-yellow-500 to-amber-600 text-black font-bold text-2xl rounded-2xl shadow-lg">HE LLEGADO AL LUGAR</button>` : ''}
          <button onclick="finalizar(${clienteActivo.id})" class="w-full mt-4 py-6 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold text-2xl rounded-2xl shadow-lg">
            FINALIZAR SERVICIO
          </button>
        </div>`
    }
  } else if (tab === 1) {
    lista.innerHTML = '<p class="text-center text-gray-500 py-20 text-xl">No tienes cliente asignado</p>'
  }
}

document.getElementById('tab-disp').onclick = () => { tab = 0; refresh() }
document.getElementById('tab-act').onclick = () => { tab = 1; refresh() }

window.aceptar = id => supabase.from('clientes').update({ tecnico_asignado_id: tecnicoId, status: 'En camino' }).eq('id', id).then(() => { tab = 1; refresh() })
window.llegada = id => supabase.from('clientes').update({ status: 'He llegado - En diagnóstico' }).eq('id', id).then(refresh)
window.finalizar = id => supabase.from('clientes').update({ status: 'Completado', tecnico_asignado_id: null }).eq('id', id).then(() => {
  document.getElementById('support-card').style.display = 'block'
  if (clienteMarker) { map.removeLayer(clienteMarker); clienteMarker = null }
  tab = 0; refresh()
})

document.getElementById('btn-cafecito').onclick = () => {
  document.getElementById('kofi-container').classList.remove('hidden')
  document.getElementById('kofi-container').scrollIntoView({ behavior: 'smooth' })
}

setInterval(() => { if (!estaOffline) refresh() }, 4000)
refresh()
</script>
</body>
</html>