<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Seguimiento | TechUIT</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={theme:{"extend":{"fontFamily":{"sans":["Inter","sans-serif"]}}}}</script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
body{font-family:'Inter',sans-serif;background:#0d1117;color:#f0f6fc;margin:0;padding:20px;display:flex;justify-content:center;align-items:center;min-height:100vh}
.card{max-width:420px;width:100%;background:#161b22;border:1px solid #30363d;border-radius:16px;padding:2rem;box-shadow:0 10px 30px rgba(0,123,255,.2);text-align:center}
#map{height:300px;border-radius:12px;margin-top:1rem;border:1px solid #30363d}
.avatar{width:64px;height:64px;border-radius:50%;object-fit:cover}
</style></head><body>
<div class="card"><h1 class="text-3xl font-bold mb-4">Seguimiento en Vivo</h1>
<p>ID: <span id="id" class="font-bold text-yellow-400">—</span></p>
<div id="status" class="my-6 text-xl font-bold">Cargando…</div>
<div id="tecnico" class="flex items-center justify-center gap-4 my-6 hidden">
<img id="foto" class="avatar" src="" alt=""><div><div id="nombre" class="font-bold text-lg"></div>
<div id="esp" class="text-sm text-gray-400"></div></div></div><div id="map"></div></div>

<script>
const supabase = Supabase.createClient('https://hsdhsgyzxalhjdihpuvo.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzZGhzZ3l6eGFsaGpkaWhwdXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODA5NDQsImV4cCI6MjA3NDc1Njk0NH0.0KDQV2032sxJZ0y2srvQi4hLe496uhLman9Nb3aqhJc');
const params = new URLSearchParams(location.search);
const orderId = params.get('id')||params.get('solicitud');
document.getElementById('id').textContent = orderId;

let map, tecMarker;

async function init(){
  const {data:orden, error} = await supabase.from('clientes').select('*,tecnicos(nombre,especialidad,foto_selfie_url)').eq('id',orderId).single();
  if(error||!orden){document.getElementById('status').innerHTML='<p class="text-red-400">Orden no encontrada</p>';return;}
  
  const txt={'pagado_verificado':'Buscando técnico…','tecnico_asignado':'Técnico asignado','tecnico_en_camino':'En camino','tecnico_llego':'¡Técnico llegó!','servicio_completado':'Servicio completado'};
  document.getElementById('status').textContent = txt[orden.status]||orden.status;

  if(orden.tecnicos){
    document.getElementById('nombre').textContent=orden.tecnicos.nombre;
    document.getElementById('esp').textContent=orden.tecnicos.especialidad;
    document.getElementById('foto').src=orden.tecnicos.foto_selfie_url?`https://hsdhsgyzxalhjdihpuvo.supabase.co/storage/v1/object/public/technician-avatars/${orden.tecnicos.foto_selfie_url}`:'https://i.pravatar.cc/150';
    document.getElementById('tecnico').classList.remove('hidden');
  }

  if(orden.lat_cliente && orden.lng_cliente){
    map=L.map('map').setView([orden.lat_cliente,orden.lng_cliente],15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.marker([orden.lat_cliente,orden.lng_cliente],{icon:L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',iconSize:[25,41],iconAnchor:[12,41]})}).addTo(map).bindPopup('Tú').openPopup();

    if(['tecnico_en_camino','tecnico_llego'].includes(orden.status)){
      supabase.channel('track').on('postgres_changes',{event:'*',schema:'public',table:'tecnico_ubicacion',filter:`tecnico_id=eq.${orden.tecnico_asignado_id}`},p=>{
        const {lat,lng}=p.new;
        if(tecMarker) tecMarker.setLatLng([lat,lng]);
        else tecMarker=L.marker([lat,lng],{icon:L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',iconSize:[25,41],iconAnchor:[12,41]})}).addTo(map).bindPopup('Técnico');
      }).subscribe();
    }
  }
}
init();
</script>
</body></html>