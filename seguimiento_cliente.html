<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TechUIT - Seguimiento en vivo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter','sans-serif'] } } } }</script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { background:#0d1117; color:#f3f4f6; margin:0; }
    #map { height: 68vh !important; width: 100% !important; }
    .gradient-blue { background: linear-gradient(90deg,#007bff,#00d4ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    /* más estilos tuyos... */
  </style>
</head>
<body class="min-h-screen">
  <!-- todo tu HTML igual -->
  <div class="max-w-lg mx-auto p-6">
    <h1 class="text-5xl font-black text-center mb-8 gradient-blue" id="titulo">Cargando...</h1>
    <div id="offline-banner" class="offline hidden"><p class="text-red-400 font-bold">Sin conexión → reconectando...</p></div>
    <div id="map" class="h-[68vh] rounded-3xl shadow-2xl shadow-blue-500/40 mb-6 overflow-hidden"></div>
    <!-- el resto igual -->
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
const supabase = createClient('https://hsdhsgyzxalhjdihpuvo.supabase.co', 'sb_publishable_HmIKr5aaqK-zxdNM5yiWNQ_G7lSH8XT')

const urlParams = new URLSearchParams(window.location.search)
const clienteId = Number(urlParams.get('id'))
if (!clienteId) location.href = 'index.html'

// ====== MAPA + FIX DEFINITIVO PARA PWA iPhone ======
const map = L.map('map', { zoomControl: false }).setView([15.507, -88.025], 15)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)

// ESTO ES EL TRUCO QUE HACE QUE iOS PWA MUESTRE LOS MARCADORES
setTimeout(() => map.invalidateSize(true), 600)
window.addEventListener('focus', () => setTimeout(() => map.invalidateSize(true), 300))

let tecnicoMarker = null, clienteMarker = null

function actualizarGPSCliente() {
  navigator.geolocation.getCurrentPosition(pos => {
    // tu código igual...
    if (!clienteMarker) {
      clienteMarker = L.circleMarker([pos.coords.latitude, pos.coords.longitude], {/*...*/}).addTo(map)
      map.setView([pos.coords.latitude, pos.coords.longitude], 17)
    }
    clienteMarker.setLatLng([pos.coords.latitude, pos.coords.longitude])
    map.invalidateSize(true)   // ← nunca falla en iPhone PWA
  }, () => {}, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 })
}
setInterval(actualizarGPSCliente, 8000)
actualizarGPSCliente()

// en cada lugar que creas o muevas un marcador → agregar:
map.invalidateSize(true)

// ====== GUARDADO HÍBRIDO (IndexedDB + localStorage) ======
function guardarUltimoId(id) {
  // Primero intenta IndexedDB
  const abrir = indexedDB.open('TechUIT', 1)
  abrir.onupgradeneeded = e => e.target.result.createObjectStore('seguimiento')
  abrir.onsuccess = e => {
    const db = e.target.result
    const tx = db.transaction('seguimiento', 'readwrite')
    tx.objectStore('seguimiento').put(id+'', 'ultimo_id')
  }
  // Si IndexedDB falla (Samsung viejos), usa localStorage como respaldo
  abrir.onerror = () => localStorage.setItem('techuit_ultimo_id', id)
}
if (clienteId) guardarUltimoId(clienteId)

// ====== BORRAR HÍBRIDO ======
function borrarSeguimiento() {
  const abrir = indexedDB.open('TechUIT', 1)
  abrir.onsuccess = e => {
    const db = e.target.result
    if (db.objectStoreNames.contains('seguimiento')) {
      db.transaction('seguimiento', 'readwrite').objectStore('seguimiento').delete('ultimo_id')
    }
  }
  localStorage.removeItem('techuit_ultimo_id')  // respaldo
}

// en mostrarGracias() y en el setTimeout de 5 min → usar borrarSeguimiento()

// el resto de tu código 100% igual
</script>

<!-- LECTURA HÍBRIDA EN index.html -->
<script>
  function leerUltimoId() {
    return new Promise(resolve => {
      const abrir = indexedDB.open('TechUIT', 1)
      abrir.onsuccess = e => {
        const db = e.target.result
        const tx = db.transaction('seguimiento', 'readonly')
        const req = tx.objectStore('seguimiento').get('ultimo_id')
        req.onsuccess = () => resolve(req.result || localStorage.getItem('techuit_ultimo_id'))
      }
      abrir.onerror = () => resolve(localStorage.getItem('techuit_ultimo_id'))
    })
  }

  leerUltimoId().then(id => {
    if (id) {
      document.getElementById('luxuryTrack').classList.remove('hidden')
      document.getElementById('trackLink').href = `seguimiento_cliente.html?id=${id}`
    }
  })
</script>
</body>
</html>