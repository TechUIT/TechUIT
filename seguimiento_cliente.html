<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>TechUIT - Seguimiento en vivo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } } }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { background:#0d1117; color:#f3f4f6; margin:0; }
    .gradient-blue { background: linear-gradient(90deg, #007bff, #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .estrella { font-size: 4.5rem; filter: drop-shadow(0 0 12px rgba(212,175,55,0.4)); transition: all 0.4s; cursor:pointer; user-select:none; }
    .estrella:hover { transform: scale(1.3) rotate(15deg); }
    .selected { color:#d4af37 !important; filter: drop-shadow(0 0 30px #d4af37); }
    .offline { background: #450a0a; border: 1px solid #7f1d1d; padding: 12px; border-radius: 12px; text-align: center; margin: 12px; }
    #map { height: 68vh !important; width: 100% !important; } /* Fix iPhone */
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-lg mx-auto p-6">
    <h1 class="text-5xl font-black text-center mb-8 gradient-blue" id="titulo">Cargando...</h1>
    <div id="offline-banner" class="offline hidden">
      <p class="text-red-400 font-bold">Sin conexión → reconectando...</p>
    </div>
    <div id="map" class="h-[68vh] rounded-3xl shadow-2xl shadow-blue-500/40 mb-6 overflow-hidden"></div>
    <div id="info" class="bg-[#161b22] border border-[#30363d] rounded-3xl p-10 text-center shadow-2xl shadow-blue-500/30">
      <h2 class="text-3xl font-bold text-cyan-400 mb-4" id="nombre_tecnico">—</h2>
      <p class="text-xl text-gray-400" id="estado">Buscando técnico...</p>
    </div>
    <div id="support-card-cliente" class="bg-gradient-to-br from-cyan-900 via-blue-900 to-black rounded-3xl p-10 text-center shadow-2xl border border-cyan-700 mt-6" style="display:none">
      <h3 class="text-4xl font-black gradient-blue mb-6">¡Gracias por usar TechUIT!</h3>
      <p class="text-xl text-gray-200 mb-8 leading-relaxed">
        Tu apoyo nos ayuda a seguir mejorando.<br>
        ¿Querés invitarnos un cafecito?
      </p>
      <div class="flex justify-center gap-6">
        <button id="btn-cafecito-cliente" class="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-400 hover:to-red-500 text-white font-bold text-xl py-6 px-14 rounded-full shadow-2xl transform hover:scale-110 transition">
          Sí, invitar un café
        </button>
        <button onclick="document.getElementById('support-card-cliente').style.display='none'" class="text-gray-400 hover:text-white underline text-lg">
          Ahora no, gracias
        </button>
      </div>
      <div id="kofi-container-cliente" class="mt-10 hidden rounded-2xl overflow-hidden shadow-2xl">
        <iframe src='https://ko-fi.com/techuit/?hidefeed=true&widget=true&embed=true&preview=true' style='border:none;width:100%;padding:4px;background:#f9f9f9;' height='712' title='techuit'></iframe>
      </div>
    </div>
  </div>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
const supabase = createClient('https://hsdhsgyzxalhjdihpuvo.supabase.co', 'sb_publishable_HmIKr5aaqK-zxdNM5yiWNQ_G7lSH8XT')
const urlParams = new URLSearchParams(window.location.search)
const clienteId = Number(urlParams.get('id'))
if (!clienteId) location.href = 'index.html'
const map = L.map('map', { zoomControl: false }).setView([15.507, -88.025], 15)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)
// Fix iPhone PWA: fuerza redibujado del mapa
setTimeout(() => map.invalidateSize(true), 800)
window.addEventListener('focus', () => setTimeout(() => map.invalidateSize(true), 400))
window.addEventListener('pageshow', () => setTimeout(() => map.invalidateSize(true), 400))
let tecnicoMarker = null
let clienteMarker = null
let intervalId = null
let estaOffline = false
window.addEventListener('online', () => {
  document.getElementById('offline-banner').classList.add('hidden')
  estaOffline = false
  if (!intervalId) iniciarActualizacion()
})
window.addEventListener('offline', () => {
  document.getElementById('offline-banner').classList.remove('hidden')
  estaOffline = true
})
function actualizarGPSCliente() {
  if (estaOffline) return
  navigator.geolocation.getCurrentPosition(
    pos => {
      const { latitude, longitude } = pos.coords
      supabase.from('clientes').update({
        lat_cliente: latitude,
        lng_cliente: longitude
      }).eq('id', clienteId)
      if (!clienteMarker) {
        clienteMarker = L.circleMarker([latitude, longitude], {
          color: '#00ff00', weight: 8, fillColor: '#00ff00', fillOpacity: 0.3, radius: 50
        }).addTo(map).bindPopup('TÚ (Cliente)').openPopup()
        map.setView([latitude, longitude], 17)
        map.invalidateSize(true)
      }
      clienteMarker.setLatLng([latitude, longitude])
    },
    () => {},
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  )
}
setInterval(actualizarGPSCliente, 8000)
actualizarGPSCliente()
function esPosicionValida(lat, lng) {
  return lat >= 12.9 && lat <= 17.4 && lng >= -89.4 && lng <= -83.1
}
async function actualizar() {
  if (estaOffline) return
  try {
    const { data: cliente, error } = await supabase
      .from('clientes')
      .select('*, tecnico_asignado_id')
      .eq('id', clienteId)
      .single()
    if (error || !cliente) return
    const latCliente = cliente.lat_cliente ?? cliente.lat
    const lngCliente = cliente.lng_cliente ?? cliente.lng
    if (latCliente && lngCliente && latCliente !== 0) {
      if (!clienteMarker) {
        clienteMarker = L.circleMarker([latCliente, lngCliente], {
          color: '#00ff00', weight: 8, fillColor: '#00ff00', fillOpacity: 0.3, radius: 50
        }).addTo(map).bindPopup('TÚ (Cliente)').openPopup()
        map.invalidateSize(true)
      }
      clienteMarker.setLatLng([latCliente, lngCliente])
    }
    if (cliente.status?.includes('Completado')) {
      clearInterval(intervalId)
      mostrarGracias(cliente)
      return
    }
    if (!cliente.tecnico_asignado_id) {
      document.getElementById('titulo').textContent = 'Esperando técnico...'
      document.getElementById('estado').textContent = 'Un técnico aceptará en breve'
      if (tecnicoMarker) { map.removeLayer(tecnicoMarker); tecnicoMarker = null }
      return
    }
    const [tecRes, posRes] = await Promise.all([
      supabase.from('tecnicos').select('nombre').eq('id', cliente.tecnico_asignado_id).single(),
      supabase.from('tecnico_ubicacion').select('lat,lng').eq('tecnico_id', cliente.tecnico_asignado_id).single()
    ]).catch(() => [null, null])
    const nombreTecnico = tecRes?.data?.nombre || 'Técnico'
    document.getElementById('nombre_tecnico').textContent = nombreTecnico
    if (cliente.status?.includes('llegad') || cliente.status?.includes('llegado')) {
      document.getElementById('titulo').textContent = `${nombreTecnico} ya llegó`
      document.getElementById('estado').textContent = 'Ya está aquí'
      if (clienteMarker) {
        const pos = clienteMarker.getLatLng()
        if (tecnicoMarker) tecnicoMarker.setLatLng(pos)
        else tecnicoMarker = L.circleMarker(pos, { color: '#00ffff', weight: 7, fillColor: '#00ffff', fillOpacity: 0.3, radius: 35 })
          .addTo(map).bindPopup(nombreTecnico).openPopup()
        map.setView(pos, 17)
        map.invalidateSize(true)
      }
      return
    }
    document.getElementById('titulo').textContent = `${nombreTecnico} está en camino`
    document.getElementById('estado').textContent = 'Llegará pronto'
    const pos = posRes?.data
    if (pos?.lat && pos?.lng && esPosicionValida(pos.lat, pos.lng)) {
      if (!tecnicoMarker) {
        tecnicoMarker = L.circleMarker([pos.lat, pos.lng], { color: '#00ffff', weight: 7, fillColor: '#00ffff', fillOpacity: 0.3, radius: 35 })
          .addTo(map).bindPopup(nombreTecnico)
      }
      tecnicoMarker.setLatLng([pos.lat, pos.lng])
    } else if (clienteMarker) {
      const base = clienteMarker.getLatLng()
      const fakeLat = base.lat + 0.0022
      const fakeLng = base.lng + 0.0022
      if (!tecnicoMarker) {
        tecnicoMarker = L.circleMarker([fakeLat, fakeLng], { color: '#00ffff', weight: 7, fillColor: '#00ffff', fillOpacity: 0.3, radius: 35 })
          .addTo(map).bindPopup(nombreTecnico)
      }
      tecnicoMarker.setLatLng([fakeLat, fakeLng])
    }
    if (clienteMarker && tecnicoMarker) {
      const bounds = L.latLngBounds([clienteMarker.getLatLng(), tecnicoMarker.getLatLng()])
      map.fitBounds(bounds, { padding: [50, 50] })
    }
  } catch (err) { console.log("Error temporal") }
}
function iniciarActualizacion() {
  clearInterval(intervalId)
  intervalId = setInterval(actualizar, 5000)
  actualizar()
}
function mostrarGracias(cliente) {
  document.getElementById('map').style.display = 'none'
  document.getElementById('titulo').innerHTML = '<span class="text-6xl font-black gradient-blue">¡Servicio completado!</span>'
  document.getElementById('info').innerHTML = `
    <h2 class="text-4xl font-black gradient-blue mb-8">¡Gracias por confiar en TechUIT!</h2>
    <p class="text-2xl text-gray-300 mb-10">¿Cómo calificarías el servicio?</p>
    <div class="flex justify-center gap-4 mb-10" id="estrellas">
      ${[1,2,3,4,5].map(n => `<span class="estrella" onclick="calificar(${n})">★</span>`).join('')}
    </div>
    <textarea id="comentario" placeholder="Comentario opcional..." class="w-full bg-[#0d1117] border border-[#30363d] rounded-2xl p-6 text-lg text-white resize-none mb-6" rows="4"></textarea>
    <button onclick="enviarCalificacion()" class="w-full py-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold text-2xl rounded-2xl shadow-lg hover:from-green-400 hover:to-emerald-500">ENVIAR CALIFICACIÓN</button>
  `
  window.calificacionSeleccionada = 0
  window.calificar = n => {
    window.calificacionSeleccionada = n
    document.querySelectorAll('.estrella').forEach((e, i) => {
      e.className = i < n ? 'estrella selected' : 'estrella'
    })
    setTimeout(() => document.getElementById('support-card-cliente').style.display = 'block', 1200)
  }
  window.enviarCalificacion = async () => {
    const comentario = document.getElementById('comentario').value
    if (window.calificacionSeleccionada > 0) {
      await supabase.from('calificaciones').insert({
        cliente_id: clienteId,
        tecnico_id: cliente.tecnico_asignado_id,
        estrellas: window.calificacionSeleccionada,
        comentario: comentario || null
      })
    }
    borrarSeguimiento()
    document.getElementById('info').innerHTML = '<h2 class="text-5xl font-black gradient-blue">¡Gracias por tu calificación!</h2><p class="text-2xl text-gray-400 mt-6">Esperamos verte pronto</p>'
  }
  setTimeout(borrarSeguimiento, 5 * 60 * 1000)
}
document.getElementById('btn-cafecito-cliente')?.addEventListener('click', () => {
  document.getElementById('kofi-container-cliente').classList.remove('hidden')
  document.getElementById('kofi-container-cliente').scrollIntoView({ behavior: 'smooth' })
})
// ALMACENAMIENTO HÍBRIDO
function guardarUltimoId(id) {
  const abrir = indexedDB.open('TechUIT', 1)
  abrir.onupgradeneeded = e => e.target.result.createObjectStore('seguimiento')
  abrir.onsuccess = e => {
    const db = e.target.result
    const tx = db.transaction('seguimiento', 'readwrite')
    tx.objectStore('seguimiento').put(id+'', 'ultimo_id')
  }
  abrir.onerror = () => localStorage.setItem('techuit_ultimo_id', id)
}
function borrarSeguimiento() {
  const abrir = indexedDB.open('TechUIT', 1)
  abrir.onsuccess = e => {
    const db = e.target.result
    if (db.objectStoreNames.contains('seguimiento')) {
      db.transaction('seguimiento', 'readwrite').objectStore('seguimiento').delete('ultimo_id')
    }
  }
  localStorage.removeItem('techuit_ultimo_id')
}
if (clienteId) guardarUltimoId(clienteId)
iniciarActualizacion()
</script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get('id');
  if (id) guardarUltimoId(id);
</script>
</body>
</html>